@using System.Linq;
@using static Todo.WebApp.Views.ViewDataNames;
@model Todo.WebApp.SharedModels.TodoList;

@{
    void ListItemHtml(string value="")
    {
        <div class="itemContainer">
            <input name="items[]" type="text" value="@value">
            <button class="addItemButton" type="button">+</button>
            <button class="removeItemButton" type="button">-</button>
        </div>
    }
}

<html>
    <head>
        <title>Todo List - @ViewData[FormTitle]</title>
        <style>
            form > * {
                display: block;
            }
        </style>
        <script>
            function addItem(itemContainer) {
                let template = document.getElementById("todo-item-template");

                let newItem = template.content.querySelector('.itemContainer').cloneNode(true);
                setOnClick(newItem);

                itemContainer.after(newItem);
            }

            function removeItem(itemContainer) {
                itemContainer.remove();
            }

            function addItemEventHandler(event) {
                let itemContainer = event.target.closest(".itemContainer");

                if (null !== itemContainer) {
                    addItem(itemContainer);
                }
            }

            function removeItemEventHandler(event) {
                let itemContainer = event.target.closest(".itemContainer");
                if (null !== itemContainer) {
                    removeItem(itemContainer);
                }
            }

            function setOnClick(listItemElementContainer) {
                let add = Array.from(listItemElementContainer.querySelectorAll(".addItemButton"));
                let remove = Array.from(listItemElementContainer.querySelectorAll(".removeItemButton"));

                add.forEach(a => a.addEventListener('click', addItemEventHandler));
                remove.forEach(r => r.addEventListener('click', removeItemEventHandler));
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", event => setOnClick(document.getElementById("todoList")));
            }
            else {
                setOnClick(document.getElementById("todoList"))
            }
        </script>
        <template id="todo-item-template">
            @{ ListItemHtml(); }
        </template>
    </head>
    <body>
        <form id="todoList" method="POST">
            <label for="title">Title</label>
            <input name="title" type="text" value="@Model?.Title">
            <label>Items</label>
            @if (Model?.Items?.Any() ?? false)
            {
                foreach (var i in Model.Items)
                {
                    ListItemHtml(i);
                }
            }
            else
            {
                ListItemHtml();
            }
            <input type="submit" value="@ViewData[SubmitOperationName]">
        </form>
    </body>
</html>
